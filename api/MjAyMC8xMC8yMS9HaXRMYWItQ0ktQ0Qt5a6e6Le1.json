{"title":"GitLab CI/CD 实践","date":"2020-10-21T15:06:51.000Z","date_formatted":{"ll":"Oct 21, 2020","L":"10/21/2020","MM-DD":"10-21"},"link":"2020/10/21/GitLab-CI-CD-实践","tags":["GitLab","Java","JavaScript"],"updated":"2021-03-02T08:23:25.622Z","content":"<img src=\"/2020/10/21/GitLab-CI-CD-%E5%AE%9E%E8%B7%B5/gitlab.svg\" class=\"\" title=\"GitLab\" alt=\"GitLab\">\n<h1 id=\"javascript-web-应用的-gitlab-ci/cd-配置\">JavaScript Web 应用的 GitLab CI/CD 配置<a title=\"#javascript-web-应用的-gitlab-ci/cd-配置\" href=\"#javascript-web-应用的-gitlab-ci/cd-配置\"></a></h1>\n<h2 id=\"pipeline\">Pipeline<a title=\"#pipeline\" href=\"#pipeline\"></a></h2>\n<p>Start -&gt; Install -&gt; Build -&gt; Publish -&gt; Verify -&gt; End</p>\n<h2 id=\"install\">Install<a title=\"#install\" href=\"#install\"></a></h2>\n<p>通过 npm install 安装依赖包，并将结果缓存到 cache 里。</p>\n<figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">script:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"string\">npm</span> <span class=\"string\">install</span> <span class=\"string\">--proxy=$PROXY</span> <span class=\"string\">--https-proxy=$PROXY</span></span><br><span class=\"line\"><span class=\"attr\">cache:</span></span><br><span class=\"line\">    <span class=\"attr\">key:</span> <span class=\"string\">$CI_COMMIT_REF_SLUG-$CI_COMMIT_SHORT_SHA</span></span><br><span class=\"line\">    <span class=\"attr\">paths:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">node_modules</span></span><br></pre></td></tr></table></figure>\n<p>如果项目依赖私有 git 仓库和代理。</p>\n<p>SSH_PRIVATE_KEY 和 SSH_KNOWN_HOSTS 为配置好的 GitLab CI/CD 变量。</p>\n<figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">variables:</span></span><br><span class=\"line\">    <span class=\"attr\">PROXY:</span> <span class=\"comment\"># proxy link</span></span><br><span class=\"line\">    <span class=\"attr\">HTTP_PROXY:</span> <span class=\"string\">$PROXY</span></span><br><span class=\"line\">    <span class=\"attr\">HTTPS_PROXY:</span> <span class=\"string\">$PROXY</span></span><br><span class=\"line\"><span class=\"attr\">before_script:</span></span><br><span class=\"line\">    <span class=\"comment\"># 项目依赖 git 私有仓库代码，因此将配置好的私钥存储到当前容器中</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"string\">eval</span> <span class=\"string\">$(ssh-agent</span> <span class=\"string\">-s)</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"string\">echo</span> <span class=\"string\">&quot;$SSH_PRIVATE_KEY&quot;</span> <span class=\"string\">|</span> <span class=\"string\">tr</span> <span class=\"string\">-d</span> <span class=\"string\">&#x27;\\r&#x27;</span> <span class=\"string\">|</span> <span class=\"string\">ssh-add</span> <span class=\"bullet\">-</span> <span class=\"string\">&gt;</span> <span class=\"string\">/dev/null</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"string\">mkdir</span> <span class=\"string\">-p</span> <span class=\"string\">~/.ssh</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"string\">chmod</span> <span class=\"number\">700</span> <span class=\"string\">~/.ssh</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"string\">echo</span> <span class=\"string\">&quot;$SSH_KNOWN_HOSTS&quot;</span> <span class=\"string\">&gt;</span> <span class=\"string\">~/.ssh/known_hosts</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"string\">chmod</span> <span class=\"number\">644</span> <span class=\"string\">~/.ssh.SSH_KNOWN_HOSTS</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"build\">Build<a title=\"#build\" href=\"#build\"></a></h2>\n<p>从缓存中拉取 Install 的结果，运行自定义构建命令并将生成的结果存入 artifacts 。</p>\n<figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">variables:</span></span><br><span class=\"line\">    <span class=\"string\">&lt;&lt;:</span> <span class=\"string\">*node-variables</span></span><br><span class=\"line\">    <span class=\"string\">&lt;&lt;:</span> <span class=\"string\">*organization-variables</span></span><br><span class=\"line\"><span class=\"attr\">cache:</span></span><br><span class=\"line\">    <span class=\"attr\">key:</span> <span class=\"string\">$CI_COMMIT_REF_SLUG-$CI_COMMIT_SHORT_SHA</span></span><br><span class=\"line\">    <span class=\"attr\">paths:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">node_modules</span></span><br><span class=\"line\">    <span class=\"comment\"># 拉取 Install 阶段生成的 node_modules</span></span><br><span class=\"line\">    <span class=\"attr\">policy:</span> <span class=\"string\">pull</span></span><br><span class=\"line\"><span class=\"attr\">artifacts:</span></span><br><span class=\"line\">    <span class=\"comment\"># 将自定义构建后的资源存储到 artifacts 中</span></span><br><span class=\"line\">    <span class=\"attr\">paths:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">dist/</span> <span class=\"comment\"># 自定义构建后的资源路径</span></span><br><span class=\"line\"><span class=\"attr\">script:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"string\">npm</span> <span class=\"string\">run</span> <span class=\"string\">build</span> <span class=\"comment\"># 自定义构建命令</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"publish\">Publish<a title=\"#publish\" href=\"#publish\"></a></h2>\n<p>使用构建好的镜像，发布静态资源。</p>\n<figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">image:</span> <span class=\"comment\"># 发布静态资源的镜像地址</span></span><br><span class=\"line\"><span class=\"attr\">script:</span> <span class=\"string\">publish</span> <span class=\"comment\"># 发布命令</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"verify\">Verify<a title=\"#verify\" href=\"#verify\"></a></h2>\n<p>一些自动化测试，代码静态分析和代码格式化。</p>\n<h1 id=\"java-web-应用的-gitlab-ci/cd-配置\">Java Web 应用的 GitLab CI/CD 配置<a title=\"#java-web-应用的-gitlab-ci/cd-配置\" href=\"#java-web-应用的-gitlab-ci/cd-配置\"></a></h1>\n<h2 id=\"pipeline-1\">Pipeline<a title=\"#pipeline-1\" href=\"#pipeline-1\"></a></h2>\n<p>Start -&gt; Complie -&gt; Package -&gt; Image -&gt; Deploy -&gt; End</p>\n<h2 id=\"complie\">Complie<a title=\"#complie\" href=\"#complie\"></a></h2>\n<p>利用 maven 对代码进行 <code>clean compile</code> ，将 verify-package.yml 报告存入 artifacts ，并将生成的 target 存入 cache 。</p>\n<figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">caches:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">key:</span> <span class=\"string\">compile-cache</span></span><br><span class=\"line\">      <span class=\"attr\">paths:</span></span><br><span class=\"line\">          <span class=\"bullet\">-</span> <span class=\"string\">$POM_DIR/**/target/classes</span></span><br><span class=\"line\">          <span class=\"bullet\">-</span> <span class=\"string\">$POM_DIR/**/target/generated-sources</span></span><br><span class=\"line\">          <span class=\"bullet\">-</span> <span class=\"string\">$POM_DIR/**/target/maven-status</span></span><br><span class=\"line\">      <span class=\"attr\">policy:</span> <span class=\"string\">push</span></span><br><span class=\"line\"><span class=\"attr\">artifacts:</span></span><br><span class=\"line\">    <span class=\"attr\">reports:</span></span><br><span class=\"line\">        <span class=\"attr\">snapshot:</span> <span class=\"string\">&#x27;$POM_DIR/**/target/verify-package.yml&#x27;</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"package\">Package<a title=\"#package\" href=\"#package\"></a></h2>\n<p>Package 依赖 Compile 。</p>\n<p>从 cache 中拉取 compile cache 。并将打包结果存入 cache 。</p>\n<figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">needs:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"string\">Compile</span></span><br><span class=\"line\"><span class=\"attr\">caches:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">key:</span> <span class=\"string\">compile-cache</span></span><br><span class=\"line\">      <span class=\"attr\">paths:</span></span><br><span class=\"line\">          <span class=\"bullet\">-</span> <span class=\"string\">$POM_DIR/**/target/classes</span></span><br><span class=\"line\">          <span class=\"bullet\">-</span> <span class=\"string\">$POM_DIR/**/target/generated-sources</span></span><br><span class=\"line\">          <span class=\"bullet\">-</span> <span class=\"string\">$POM_DIR/**/target/maven-status</span></span><br><span class=\"line\">      <span class=\"attr\">policy:</span> <span class=\"string\">pull</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">key:</span> <span class=\"string\">$&#123;CACHE_KEY&#125;-target</span></span><br><span class=\"line\">      <span class=\"attr\">paths:</span></span><br><span class=\"line\">          <span class=\"bullet\">-</span> <span class=\"string\">./**/*.war</span></span><br><span class=\"line\">          <span class=\"bullet\">-</span> <span class=\"string\">./**/*.zip</span></span><br><span class=\"line\">      <span class=\"attr\">policy:</span> <span class=\"string\">push</span></span><br><span class=\"line\"><span class=\"attr\">script:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"string\">mvn</span> <span class=\"string\">package</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"image\">Image<a title=\"#image\" href=\"#image\"></a></h2>\n<p>利用 package 的 cache 和构建好的基础环境镜像构建应用镜像放入 cache 中。</p>\n<figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">caches:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">key:</span> <span class=\"string\">$&#123;CACHE_KEY&#125;-target</span></span><br><span class=\"line\">      <span class=\"attr\">paths:</span></span><br><span class=\"line\">          <span class=\"bullet\">-</span> <span class=\"string\">./**/*.war</span></span><br><span class=\"line\">      <span class=\"attr\">policy:</span> <span class=\"string\">pull</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">key:</span> <span class=\"string\">$&#123;CACHE_KEY&#125;-image-repo-file</span></span><br><span class=\"line\">      <span class=\"attr\">paths:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">$&#123;IMAGE_REPO_FILE&#125;</span></span><br><span class=\"line\">     <span class=\"attr\">policy:</span> <span class=\"string\">push</span></span><br><span class=\"line\"><span class=\"attr\">script:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"string\">docker</span> <span class=\"string\">login</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"string\">image</span> <span class=\"string\">build</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"deploy\">Deploy<a title=\"#deploy\" href=\"#deploy\"></a></h2>\n<p>拉取 cache 中构建好的应用镜像，发布到机器上。</p>\n","prev":{"title":"CSS 实现表格的首行首列吸顶","link":"2021/02/27/CSS-实现表格的首行首列吸顶"},"next":{"title":"Practical application of Cartesian product","link":"2020/08/17/Practical-application-of-Cartesian-product"},"plink":"https://syaki.github.io/2020/10/21/GitLab-CI-CD-实践/","toc":[{"id":"javascript-web-应用的-gitlab-ci/cd-配置","title":"JavaScript Web 应用的 GitLab CI&#x2F;CD 配置","index":"1","children":[{"id":"pipeline","title":"Pipeline","index":"1.1"},{"id":"install","title":"Install","index":"1.2"},{"id":"build","title":"Build","index":"1.3"},{"id":"publish","title":"Publish","index":"1.4"},{"id":"verify","title":"Verify","index":"1.5"}]},{"id":"java-web-应用的-gitlab-ci/cd-配置","title":"Java Web 应用的 GitLab CI&#x2F;CD 配置","index":"2","children":[{"id":"pipeline-1","title":"Pipeline","index":"2.1"},{"id":"complie","title":"Complie","index":"2.2"},{"id":"package","title":"Package","index":"2.3"},{"id":"image","title":"Image","index":"2.4"},{"id":"deploy","title":"Deploy","index":"2.5"}]}],"copyright":{"author":"Syaki","link":"<a href=\"https://syaki.github.io/2020/10/21/GitLab-CI-CD-实践/\" title=\"GitLab CI/CD 实践\">https://syaki.github.io/2020/10/21/GitLab-CI-CD-实践/</a>","license":"Attribution-NonCommercial-NoDerivatives 4.0 International (<a href=\\\"https://creativecommons.org/licenses/by-nc-sa/4.0/\\\" rel=\\\"external nofollow\\\" target=\\\"_blank\\\">CC BY-NC-ND 4.0</a>)"}}